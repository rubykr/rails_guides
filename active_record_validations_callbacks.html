<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Ruby on Rails Guides: 엑티브 레코드 데이터 검증(Validation)과 콜백(Callback)</title>

<link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

<link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong>More at <a href="http://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <a href="http://rubyonrails.org/">Overview</a> |
      <a href="http://rubyonrails.org/download">Download</a> |
      <a href="http://rubyonrails.org/deploy">Deploy</a> |
      <a href="http://rails.lighthouseapp.com/projects/8994-ruby-on-rails/overview">Code</a> |
      <a href="http://rubyonrails.org/screencasts">Screencasts</a> |
      <a href="http://rubyonrails.org/documentation">Documentation</a> |
      <a href="http://rubyonrails.org/ecosystem">Ecosystem</a> |
      <a href="http://rubyonrails.org/community">Community</a> |
      <a href="http://weblog.rubyonrails.org/">Blog</a>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Return to home page">Guides.rubyonrails.org</a></h1>
      <p class="hide"><a href="#mainCol">Skip navigation</a>.</p>
      <ul class="nav">
        <li><a href="index.html">홈</a></li>
        <li class="index"><a href="index.html" onclick="guideMenu(); return false;" id="guidesMenu">목차</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="L">
              <dt>시작</dt>
              <dd><a href="getting_started.html">레일즈 시작하기</a></dd>
              <dt>모델(Models)</dt>
              <dd><a href="migrations.html">레일즈 데이터베이스 마이그레이션</a></dd>
              <dd><a href="active_record_validations_callbacks.html">엑티브 레코드 데이터 검증(Validation)과 Callback(콜백)</a></dd>
              <dd><a href="association_basics.html">엑티브 레코드 Association(관계)</a></dd>
              <dd><a href="active_record_querying.html">엑티브 레코드 쿼리 인터페이스</a></dd>
              <dt>뷰(Views)</dt>
              <dd><a href="layouts_and_rendering.html">레이아웃(Layouts)과 렌더링(Rendering)</a></dd>
              <dd><a href="form_helpers.html">액션 뷰 폼 핼퍼(Action View Form Helpers)</a></dd>
              <dt>컨트롤러(Controllers)</dt>
              <dd><a href="action_controller_overview.html">액션 컨트롤러 둘러보기</a></dd>
              <dd><a href="routing.html">외부 요청에 대한 레일즈 라우팅</a></dd>
            </dl>
            <dl class="R">
              <dt>심화내용</dt>
              <dd><a href="active_support_core_extensions.html">엑티브 서포트(Active Support) 확장(Core Extensions)</a></dd>
              <dd><a href="i18n.html">레일즈 국제화I(nternationalization) API</a></dd>
              <dd><a href="action_mailer_basics.html">액션 메일러의 기본</a></dd>
              <dd><a href="testing.html">레일즈 어플리케이션 테스트하기</a></dd>
              <dd><a href="security.html">레일즈 어플리케이션의 보안</a></dd>
              <dd><a href="debugging_rails_applications.html">레일즈 어플리케이션 디버깅</a></dd>
              <dd><a href="performance_testing.html">레일즈 어플리케이션 성능 테스트하기</a></dd>
              <dd><a href="configuring.html">레일즈 어플리케이션 설정</a></dd>
              <dd><a href="command_line.html">레일즈 커멘드라인 도구와 Rake 테스크</a></dd>
              <dd><a href="caching_with_rails.html">레일즈를 이용한 캐싱</a></dd>

              <dt>레일즈 확장하기(Extending Rails)</dt>
              <dd><a href="plugins.html">레일즈 플러그인 작성의 기본</a></dd>
              <dd><a href="rails_on_rack.html">렉 위의 레일즈(Rails on Rack)</a></dd>
              <dd><a href="generators.html">레일즈 제너레이터(Generator) 제작과 수정</a></dd>

              <dt>루비 온 레이즈에 기여하기</dt>
              <dd><a href="contributing_to_ruby_on_rails.html">루비 온 레이즈에 기여하기</a></dd>
              <dd><a href="api_documentation_guidelines.html">API 문서 가이드라인</a></dd>
              <dd><a href="ruby_on_rails_guides_guidelines.html">루비 온 레일즈 가이드에 대한 가이드라인</a></dd>

              <dt>Release Notes</dt>
              <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes</a></dd>
              <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes</a></dd>
              <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes</a></dd>
            </dl>
          </div>
        </li>
        <li><a href="contribute.html">기여하기</a></li>
        <li><a href="credits.html">수고하신 분들</a></li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>엑티브 레코드 데이터 검증(Validation)과 콜백(Callback)</h2>
<p>이 가이드는 엑티브 레코드 객체의 생명 주기에 관여하는 방법을 안내합니다. 엑티브 레코드가 데이터베이스에 정보를 입력하기 전에 객체의 데이터 검증을 어떻게 할 것인지, 그리고 객체의 생명 주기에서 정확한 부분에 원하는 작업을 수행하는 방법을 배울 것입니다.</p>
<p>이 가이드를 읽고 주어진 개념을 시험한 후, 다음 내용을 할 수 있는 것을 기대합니다.:</p>
<ul>
	<li>엑티브 레코드 객체의 생명 주기에 대한 이해</li>
	<li>내장된 엑티브 레코드 데이터 검증 헬퍼 사용 방법</li>
	<li>맞춤형 데이터 검증 메소드 만들기</li>
	<li>데이터 검증 과정으로 에러 메세지 만들어서 사용하기</li>
	<li>객체의 생명 주기내에서 이벤트에 대응하는 콜백 메소드 만들기</li>
	<li>콜백 함수를 위한 공통의 동작들을 캡슐화 한 특별한 클래스 만들기</li>
	<li>원본 클래스의 바깥에서 생명 주기 이벤트에 반응하는 옵저버 만들기</li>
</ul>

            <div id="subCol">
        <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
        <ol class="chapters">
<li><a href="#the-object-life-cycle">객체 생명 주기</a></li><li><a href="#validations-overview">데이터 검증 둘러보기</a><ul><li><a href="#why-use-validations">왜 데이터 검증을 사용하는가?</a></li> <li><a href="#when-does-validation-happen">데이터 검증은 언제하나?</a></li> <li><a href="#skipping-validations">데이터 검증 무시하기</a></li> <li><a href="#valid-invalid"><tt>valid?</tt> 와 <tt>invalid?</tt></a></li> <li><a href="#validations_overview-errors"><tt>errors[]</tt></a></li></ul></li><li><a href="#validation-helpers">데이터 검증 헬퍼 (Validation helpers)</a><ul><li><a href="#validates_acceptance_of"><tt>validates_acceptance_of</tt> (수락 검증)</a></li> <li><a href="#validates_associated"><tt>validates_associated</tt></a></li> <li><a href="#validates_confirmation_of"><tt>validates_confirmation_of</tt></a></li> <li><a href="#validates_exclusion_of"><tt>validates_exclusion_of</tt></a></li> <li><a href="#validates_format_of"><tt>validates_format_of</tt></a></li> <li><a href="#validates_inclusion_of"><tt>validates_inclusion_of</tt></a></li> <li><a href="#validates_length_of"><tt>validates_length_of</tt></a></li> <li><a href="#validates_numericality_of"><tt>validates_numericality_of</tt></a></li> <li><a href="#validates_presence_of"><tt>validates_presence_of</tt></a></li> <li><a href="#validates_uniqueness_of"><tt>validates_uniqueness_of</tt></a></li> <li><a href="#validates_with"><tt>validates_with</tt></a></li> <li><a href="#validates_each"><tt>validates_each</tt></a></li></ul></li><li><a href="#common-validation-options">Common Validation Options</a><ul><li><a href="#allow_nil"><tt>:allow_nil</tt></a></li> <li><a href="#allow_blank"><tt>:allow_blank</tt></a></li> <li><a href="#message"><tt>:message</tt></a></li> <li><a href="#on"><tt>:on</tt></a></li></ul></li><li><a href="#conditional-validation">Conditional Validation</a><ul><li><a href="#using-a-symbol-with-if-and-unless">Using a Symbol with <tt>:if</tt> and <tt>:unless</tt></a></li> <li><a href="#using-a-string-with-if-and-unless">Using a String with <tt>:if</tt> and <tt>:unless</tt></a></li> <li><a href="#using-a-proc-with-if-and-unless">Using a Proc with <tt>:if</tt> and <tt>:unless</tt></a></li></ul></li><li><a href="#creating-custom-validation-methods">Creating Custom Validation Methods</a></li><li><a href="#working-with-validation-errors">데이터 검증 에러로 작업하기</a><ul><li><a href="#working_with_validation_errors-errors"><tt>errors</tt></a></li> <li><a href="#working_with_validation_errors-errors-2"><tt>errors[]</tt></a></li> <li><a href="#errors-add"><tt>errors.add</tt></a></li> <li><a href="#errors-base"><tt>errors[:base]</tt></a></li> <li><a href="#errors-clear"><tt>errors.clear</tt></a></li> <li><a href="#errors-size"><tt>errors.size</tt></a></li></ul></li><li><a href="#displaying-validation-errors-in-the-view">Displaying Validation Errors in the View</a><ul><li><a href="#error_messages-and-error_messages_for"><tt>error_messages</tt> and <tt>error_messages_for</tt></a></li> <li><a href="#customizing-the-error-messages-css">Customizing the Error Messages <span class="caps">CSS</span></a></li> <li><a href="#customizing-the-error-messages-html">Customizing the Error Messages <span class="caps">HTML</span></a></li></ul></li><li><a href="#callbacks-overview">Callbacks Overview</a><ul><li><a href="#callback-registration">Callback Registration</a></li></ul></li><li><a href="#available-callbacks">Available Callbacks</a><ul><li><a href="#creating-an-object">Creating an Object</a></li> <li><a href="#updating-an-object">Updating an Object</a></li> <li><a href="#destroying-an-object">Destroying an Object</a></li> <li><a href="#after_initialize-and-after_find"><tt>after_initialize</tt> and <tt>after_find</tt></a></li></ul></li><li><a href="#running-callbacks">Running Callbacks</a></li><li><a href="#skipping-callbacks">Skipping Callbacks</a></li><li><a href="#halting-execution">Halting Execution</a></li><li><a href="#relational-callbacks">Relational Callbacks</a></li><li><a href="#conditional-callbacks">Conditional Callbacks</a><ul><li><a href="#using-if-and-unless-with-a-symbol">Using <tt>:if</tt> and <tt>:unless</tt> with a Symbol</a></li> <li><a href="#using-if-and-unless-with-a-string">Using <tt>:if</tt> and <tt>:unless</tt> with a String</a></li> <li><a href="#using-if-and-unless-with-a-proc">Using <tt>:if</tt> and <tt>:unless</tt> with a Proc</a></li> <li><a href="#multiple-conditions-for-callbacks">Multiple Conditions for Callbacks</a></li></ul></li><li><a href="#callback-classes">Callback Classes</a></li><li><a href="#observers">Observers</a><ul><li><a href="#creating-observers">Creating Observers</a></li> <li><a href="#registering-observers">Registering Observers</a></li> <li><a href="#sharing-observers">Sharing Observers</a></li></ul></li><li><a href="#changelog">Changelog</a></li></ol></div>
    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="the-object-life-cycle">1 객체 생명 주기</h3>
<p>레일즈 어플리케이션 실행중에, 객체는 만들어지고, 갱신되고, 삭제 됩니다. 엑티브 레코드는 이러한 <em>객체 생명 주기</em>내에서 가로채기(hook)를 제공합니다. 그래서 여러분은 어플리케이션과 데이터를 조종할 수 있습니다.</p>
<p>데이터 검증은 데이터베이스에 오직 유효만 데이터의 입력을 보장합니다. 콜백과 옵저버는 객체의 상태 변화 전/후에 로직을 실행하도록 허락합니다.</p>
<h3 id="validations-overview">2 데이터 검증 둘러보기</h3>
<p>레일즈의 데이터 검증을 자세히 알아보기전에, 여러분은 큰 그림 속에서 어떻게 데이터 검증이 수행되는지 이해해야 합니다.</p>
<h4 id="why-use-validations">2.1 왜 데이터 검증을 사용하는가?</h4>
<p>데이터 검증은 오직 유효한 데이터만 데이터베이스에 들어가는 것을 보장합니다. 예를들어, 모든 회원들이 유효한 이메일 주소와 편지 주소를 입력해야 하는 것은 어플리케이션에 중요한 점이 될 수 있습니다.</p>
<p>여기 데이터베이스에 데이터를 저장하기 전에 데이터 검증을 하는 몇가지 방법이 있습니다. (데이터베이스 고유의 제약사항, 클라이언트 측에서 데이터 검증, 컨트롤러 수준의 데이터 검증, 그리고 모델 수준의 데이터 검증을 포함합니다.)</p>
<ul>
	<li>데이터베이스 제약사항과 (혹은) 저장 프로시저(stored proceture)는 데이터베이스 의존적인 데이터 검증 방법입니다. 그리고 이는 테스트하고 관리하기 좀 더 어렵습니다. 그럼에도, 여러분의 데이터베이스를 다른 어플리케이션이 사용한다면, 데이터베이스 수준의 몇몇 제약 사항을 사용하는 건 좋은 생각입니다. 추가로, 데이터베이스 수준 데이터 검증은 다른 방법으로 구현하기 어려울 수 있는 몇가지 것(가령, 자주 사용되는 테이블에서 유일성 검증 따위)를 안전하게 다룰 수 있습니다.</li>
	<li>클라이언트 측 데이터 검증은 유용할 수 있습니다. 그러나 이것만 사용하면, 일반적으로 믿기 힘듭니다. 만약 자바스크립을 이용해서 구현했다면, 자바스크립트가 꺼져있는 사용자 브라우저 경우에 검사를 우회할 수 있습니다. 그럼에도, 다른 기술들과 함께 사용하면, 클라이언트 측 데이터 검증은 여러분의 사이트에서 즉각적인 피드백을 사용자들에게 줄 수 있어서 사용자에게 편리함을 제공할 수 있습니다.</li>
	<li>컨트롤러 수준의 데이터 검증은 마음을 끕니다. 그러나 자주 테스트나 유지 보수를 하기 어렵게 만듭니다. 가능하면, <a href="http://weblog.jamisbuck.org/2006/10/18/skinny-controller-fat-model">컨트롤러 가볍게 유지하기</a> 가 좋은 생각입니다. 장기간에 걸처 작업을 할때 이런 습관은 여러분의 어플리케이션을 제작을 더 편하게 만들 겁니다.</li>
	<li>모델 수준의 데이터 검증은 데이터베이스에 유효한 데이터만 입력하는 가장 좋은 방법입니다. 이 데이터 검증은 데이터베이스를 신뢰하지 않습니다. 그리고 최종 고객이 우회해서 접근할 수 있는 기회도 제공하지 않습니다. 그리고 테스트와 유지보스에 편리합니다. 레일즈는 공통적인 요구 사항에 대한 내장된 헬퍼를 제공하고, 맞춤형 데이터 검증 제작을 손쉽게 할수 있도록 지원합니다.</li>
</ul>
<h4 id="when-does-validation-happen">2.2 데이터 검증은 언제하나?</h4>
<p>엑티브 레코드 객체는 두 종류가 있습니다.:데이터베이스의 한열(row)와 대응하는 것과, 그렇지 않은 것이죠. 새로운 객체를 만들때, 예컨데 <tt>new</tt> 메소드를 이용해서, 이 객체는 아직 데이터베이스와 대응하지 않습니다. 한번이라도 해당 객체에 대해서 <tt>save</tt>를 호출하면 그것은 정확한 데이터메이스 테이블에 저장 됩니다. 엑티브 레코드는 <tt>new_record?</tt> 인스턴스 메소드르 사용해서 해당 객체가 데이터베이스에 연결되었는지를 알 수 있습니다. 다음의 간단한 엑티브 레코드 클래스를 생각해보세요.:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
end
</pre>
</div>
</notextile>

<p>이것이 어떻게 동작하는지는, 몇가지 <tt>rails console</tt> 결과 관찰로 알 수 있습니다.:</p>
<notextile>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&gt;&gt; p = Person.new(:name =&gt; &quot;John Doe&quot;)
=&gt; #&lt;Person id: nil, name: &quot;John Doe&quot;, created_at: nil, :updated_at: nil&gt;
&gt;&gt; p.new_record?
=&gt; true
&gt;&gt; p.save
=&gt; true
&gt;&gt; p.new_record?
=&gt; false
</pre>
</div>
</notextile>

<p>새로운 레코드 만들기와 저장하기는 데이터베이스에 <tt>INSERT</tt> <span class="caps">SQL</span> 명령을 전달할 것입니다. 존재하는 레코드 정보 갱신은 <tt>UPDATE</tt> <span class="caps">SQL</span> 명령어를 전달합니다. 데이터 검증은 보통 데이터베이스에 이런 명령어를 전달되지 전에 실행 됩니다. 만약에 데이터 검증이 하나라도 실패하면, 해당 객체는 타당하지 않은 객체로 기록되고, 엑티브 레코드는 <tt>INSERT</tt>나 <tt>UPDATE</tt> 명령을 실행하지 않습니다. 이는 데이터베이스에 타당하지 않은 객체 저장 방지를 돕습니다. 여러분은 객체가 만들어때, 저장될때, 갱신될때 확인할 데이터 검증 규칙을 지정할 수 있습니다.</p>
<div class='warning'><p>데이터베이스 안에서 객체의 상태를 바꾸는 방법은 많습니다. 몇가지 메소드는 데이터 검증을 실행하지만, 몇몇은 그렇지 않겠죠. 이는 여러분이 주의 깊지 못하면, 잘못된 상태로 데이터베이스에 객체를 저장할 가능성이 있다는 것을 의미합니다.</p></div>
<p>다음은 메소드는 데이터 검증을 실행시킵니다. 그리고 객체가 유효할때만 데이터베이스에 저장합니다.:</p>
<ul>
	<li><tt>create</tt></li>
	<li><tt>create!</tt></li>
	<li><tt>save</tt></li>
	<li><tt>save!</tt></li>
	<li><tt>update</tt></li>
	<li><tt>update_attributes</tt></li>
	<li><tt>update_attributes!</tt></li>
</ul>
<p>bang(빵!) 버전(e.g <tt>save!</tt>)은 객체가 타당하지 않으면 예외를 발생 시킵니다. non-bang 버전은 발생 시키지 않습니다.:<tt>save</tt>와 <tt>update</tt>와 <tt>update_attributes</tt>는 <tt>false</tt>를 반환하고, <tt>create</tt>와 <tt>update</tt>는 그냥 객체를 반환합니다.</p>
<h4 id="skipping-validations">2.3 데이터 검증 무시하기</h4>
<p>다음 메소드는 데이터 검증을 하지 않습니다. 그리고 데이터의 타당성에 개의치 않고 객체를 데이터베이스에 저장합니다. 이 메소드는 주의 깊게 사용해야 합니다.</p>
<ul>
	<li><tt>decrement!</tt></li>
	<li><tt>decrement_counter</tt></li>
	<li><tt>increment!</tt></li>
	<li><tt>increment_counter</tt></li>
	<li><tt>toggle!</tt></li>
	<li><tt>update_all</tt></li>
	<li><tt>update_attribute</tt></li>
	<li><tt>update_counters</tt></li>
</ul>
<p><tt>save</tt> 역시 <tt>:validate => false</tt>를 인자로 넘기면 데이터 검증을 하지 않습니다. 이 기법은 신중하게 사용하세요.</p>
<ul>
	<li><tt>save(:validate => false)</tt></li>
</ul>
<h4 id="valid-invalid">2.4 <tt>valid?</tt> 와 <tt>invalid?</tt></h4>
<p>객체의 유효 여부를 검사하기 위해 레일즈는 <tt>valid?</tt> 메소드를 사용합니다. 여러분도 이 메소드를 사용할 수 있습니다. <tt>valid?</tt>는 데이터 검증을 실행하고 아무런 에러가 없으면 true(참)을 그렇지 않으면 false(거짓)을 반환합니다.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates :name, :presence =&gt; true
end

Person.create(:name =&gt; &quot;John Doe&quot;).valid? # =&gt; true
Person.create(:name =&gt; nil).valid? # =&gt; false
</pre>
</div>
</notextile>

<p>엑티브 레코드가 데이터 검증을 수행 중일때, <tt>errors</tt> 인스턴스 메소드를 통해서 발견된 어떤 에러든지 접근할 수 있습니다. 기본적으로, 데이터 검증을 실행한 후에 <tt>errors</tt> 인스턴스 메소드가 반환한 컬렉션 객체가 비어 있으면, 객체는 유효합니다.</p>
<p><tt>new</tt>로 생성된 객체는 기술적으로 유효하지 않은 정보를 담고 있더라도, 에러를 보고하지 않는 다는 점에 유의하세요. 데이터 검증은 <tt>new</tt>를 사용중에 동작하지 않기 때문입니다.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates :name, :presence =&gt; true
end

&gt;&gt; p = Person.new
=&gt; #&lt;Person id: nil, name: nil&gt;
&gt;&gt; p.errors
=&gt; {}

&gt;&gt; p.valid?
=&gt; false
&gt;&gt; p.errors
=&gt; {:name=&gt;[&quot;can't be blank&quot;]}

&gt;&gt; p = Person.create
=&gt; #&lt;Person id: nil, name: nil&gt;
&gt;&gt; p.errors
=&gt; {:name=&gt;[&quot;can't be blank&quot;]}

&gt;&gt; p.save
=&gt; false

&gt;&gt; p.save!
=&gt; ActiveRecord::RecordInvalid: Validation failed: Name can't be blank

&gt;&gt; Person.create!
=&gt; ActiveRecord::RecordInvalid: Validation failed: Name can't be blank
</pre>
</div>
</notextile>

<p><tt>invalid?</tt>는 간단히 <tt>valid?</tt>의 반대입니다. <tt>invalid?</tt>는 데이터 검증을 실행하고, 객체에 어떠한 에러라도 추가되면 true(참)을 반환하고 반대면 false(거짓)을 반환합니다.</p>
<h4 id="validations_overview-errors">2.5 <tt>errors[]</tt></h4>
<p>객체가 가진 특정 속성(attribute)의 타당성 확인을 위해서, <tt>errors[:attribute]</tt>를 사용할 수 있습니다. 그것은 <tt>:attribute</tt>을 위한 모든 에러를 가진 배열을 반환합니다. 만약 특정 속성에 대한 에러가 없으면, 비어있는 배열이 반환됩니다.</p>
<p>이 메소드는 오직 데이터 검증 <em>실행 후</em>에만 유용합니다. 왜냐하면, 오직 에러 컬렉션을 조회할 뿐이고 데이터 검증을 실행하지 않기 때문입니다. 그것은 위에 설명한 <tt>ActiveRecord::Base#invalid?</tt> 메소드와 다릅니다. 왜냐하면, 객체의 타당성 전체를 검사하지는 않기 때문이죠. 그것은 오직 객체의 개발 속성에 대한 에러가 존재하는지 여부만 살핍니다.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates :name, :presence =&gt; true
end

&gt;&gt; Person.new.errors[:name].any? # =&gt; false
&gt;&gt; Person.create.errors[:name].any? # =&gt; true
</pre>
</div>
</notextile>

<p>우리는 데이터 검증 에러에 대한 자세한 사항을 <a href="#working-with-validation-errors">데이터 검증 에러로 작업하기</a> 섹션에서 다를 것입니다. 지금은, 레일즈가 제공하는 내장된 데이터 검증 헬퍼로 돌아가죠.</p>
<h3 id="validation-helpers">3 데이터 검증 헬퍼 (Validation helpers)</h3>
<p>엑티브 레코드는 미리 정의된 많은 데이터 검증 헬퍼를 제공합니다. 이건 클래스 정의 내부에서 직접 사용할 수 있습니다. 이런 헬퍼는 공통의 데이터 검증 규칙을 제공합니다. 매번 검증이 실패할때, 한 에러 메세지가 해당 객체의 <tt>errors</tt> 컬렉션에 추가되고, 이 메세지는 검증 대상의 필드와 관련있습니다.</p>
<p>각 헬퍼는 속성을 원하는 숫자 만큼 받아들입니다. 그래서 같은 종류의 검증에  여러개의 속성을 한줄로 추가할 수 있습니다.</p>
<p>모든 헬퍼는 <tt>:on</tt>과 <tt>:message</tt> 옵션을 받을 수 있습니다. <tt>:message</tt> 옵션은 검증이 실행되고 실패일 경우에 <tt>errors</tt> 컬렉션에 추가될 메세지를 지정할 수 있습니다. <tt>:on</tt> 옵션은 <tt>:save</tt>(기본값), <tt>:create</tt> 또는 <tt>:update</tt> 어느 시점의 값을 검사할 것인지 지정합니다. 데이터 검증 헬퍼 각 메소드는 기본 에러 메세지 값을 가지고 있습니다. 기본 메세지는 <tt>:message</tt>가 지정되지 않았을때 사용됩니다. 자, 사용할 수 있는 헬퍼들을 하나씩 살펴봅시다.</p>
<h4 id="validates_acceptance_of">3.1 <tt>validates_acceptance_of</tt> (수락 검증)</h4>
<p>폼이 실행된 후에, 유저 인터페이스 상에서 체크되어 있는 체크박스를 검증합니다. 이것은 보통 사용자가 여러분의 어플리케이션의 서비스 계약 사항의 동의 확인이 필요할때, 어떤 텍스트를 읽었는지 확인하거나 그 비슷한 상황에서 사용됩니다. 이 검증은 웹 어플리케이션에 매우 특화되어 있는 것이고, 이 수락(acceptance)은 데이터베이스 내에 어떤 곳에도 구지 기록될 필요는 없습니다.(만약 이를 위한 필드를 만들어 놓지 않으면, 이 헬퍼는 가상의 속성을 만듭니다.)</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_acceptance_of :terms_of_service
end
</pre>
</div>
</notextile>

<p><tt>validates_acceptance_of</tt>의 기본 에러 메세지는 &#8220;<em>must be accepted</em>&#8221; 입니다.</p>
<p><tt>validates_acceptance_of</tt> can receive an <tt>:accept</tt> option, which determines the value that will be considered acceptance. It defaults to &#8220;1&#8221;, but you can change this.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_acceptance_of :terms_of_service, :accept =&gt; 'yes'
end
</pre>
</div>
</notextile>

<h4 id="validates_associated">3.2 <tt>validates_associated</tt></h4>
<p>You should use this helper when your model has associations with other models and they also need to be validated. When you try to save your object, <tt>valid?</tt> will be called upon each one of the associated objects.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Library &lt; ActiveRecord::Base
  has_many :books
  validates_associated :books
end
</pre>
</div>
</notextile>

<p>This validation will work with all of the association types.</p>
<div class='warning'><p>Don&#8217;t use <tt>validates_associated</tt> on both ends of your associations. They would call each other in an infinite loop.</p></div>
<p>The default error message for <tt>validates_associated</tt> is &#8220;<em>is invalid</em>&#8221;. Note that each associated object will contain its own <tt>errors</tt> collection; errors do not bubble up to the calling model.</p>
<h4 id="validates_confirmation_of">3.3 <tt>validates_confirmation_of</tt></h4>
<p>You should use this helper when you have two text fields that should receive exactly the same content. For example, you may want to confirm an email address or a password. This validation creates a virtual attribute whose name is the name of the field that has to be confirmed with &#8220;_confirmation&#8221; appended.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_confirmation_of :email
end
</pre>
</div>
</notextile>

<p>In your view template you could use something like</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= text_field :person, :email %&gt;
&lt;%= text_field :person, :email_confirmation %&gt;
</pre>
</div>
</notextile>

<p>This check is performed only if <tt>email_confirmation</tt> is not <tt>nil</tt>. To require confirmation, make sure to add a presence check for the confirmation attribute (we&#8217;ll take a look at <tt>validates_presence_of</tt> later on this guide):</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_confirmation_of :email
  validates_presence_of :email_confirmation
end
</pre>
</div>
</notextile>

<p>The default error message for <tt>validates_confirmation_of</tt> is &#8220;<em>doesn&#8217;t match confirmation</em>&#8221;.</p>
<h4 id="validates_exclusion_of">3.4 <tt>validates_exclusion_of</tt></h4>
<p>This helper validates that the attributes&#8217; values are not included in a given set. In fact, this set can be any enumerable object.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Account &lt; ActiveRecord::Base
  validates_exclusion_of :subdomain, :in =&gt; %w(www us ca jp),
    :message =&gt; &quot;Subdomain %{value} is reserved.&quot;
end
</pre>
</div>
</notextile>

<p>The <tt>validates_exclusion_of</tt> helper has an option <tt>:in</tt> that receives the set of values that will not be accepted for the validated attributes. The <tt>:in</tt> option has an alias called <tt>:within</tt> that you can use for the same purpose, if you&#8217;d like to. This example uses the <tt>:message</tt> option to show how you can include the attribute&#8217;s value.</p>
<p>The default error message for <tt>validates_exclusion_of</tt> is &#8220;<em>is reserved</em>&#8221;.</p>
<h4 id="validates_format_of">3.5 <tt>validates_format_of</tt></h4>
<p>This helper validates the attributes&#8217; values by testing whether they match a given regular expression, which is specified using the <tt>:with</tt> option.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Product &lt; ActiveRecord::Base
  validates_format_of :legacy_code, :with =&gt; /\A[a-zA-Z]+\z/,
    :message =&gt; &quot;Only letters allowed&quot;
end
</pre>
</div>
</notextile>

<p>The default error message for <tt>validates_format_of</tt> is &#8220;<em>is invalid</em>&#8221;.</p>
<h4 id="validates_inclusion_of">3.6 <tt>validates_inclusion_of</tt></h4>
<p>This helper validates that the attributes&#8217; values are included in a given set. In fact, this set can be any enumerable object.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Coffee &lt; ActiveRecord::Base
  validates_inclusion_of :size, :in =&gt; %w(small medium large),
    :message =&gt; &quot;%{value} is not a valid size&quot;
end
</pre>
</div>
</notextile>

<p>The <tt>validates_inclusion_of</tt> helper has an option <tt>:in</tt> that receives the set of values that will be accepted. The <tt>:in</tt> option has an alias called <tt>:within</tt> that you can use for the same purpose, if you&#8217;d like to. The previous example uses the <tt>:message</tt> option to show how you can include the attribute&#8217;s value.</p>
<p>The default error message for <tt>validates_inclusion_of</tt> is &#8220;<em>is not included in the list</em>&#8221;.</p>
<h4 id="validates_length_of">3.7 <tt>validates_length_of</tt></h4>
<p>This helper validates the length of the attributes&#8217; values. It provides a variety of options, so you can specify length constraints in different ways:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_length_of :name, :minimum =&gt; 2
  validates_length_of :bio, :maximum =&gt; 500
  validates_length_of :password, :in =&gt; 6..20
  validates_length_of :registration_number, :is =&gt; 6
end
</pre>
</div>
</notextile>

<p>The possible length constraint options are:</p>
<ul>
	<li><tt>:minimum</tt> &#8211; The attribute cannot have less than the specified length.</li>
	<li><tt>:maximum</tt> &#8211; The attribute cannot have more than the specified length.</li>
	<li><tt>:in</tt> (or <tt>:within</tt>) &#8211; The attribute length must be included in a given interval. The value for this option must be a range.</li>
	<li><tt>:is</tt> &#8211; The attribute length must be equal to the given value.</li>
</ul>
<p>The default error messages depend on the type of length validation being performed. You can personalize these messages using the <tt>:wrong_length</tt>, <tt>:too_long</tt>, and <tt>:too_short</tt> options and <tt>%{count}</tt> as a placeholder for the number corresponding to the length constraint being used. You can still use the <tt>:message</tt> option to specify an error message.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_length_of :bio, :maximum =&gt; 1000,
    :too_long =&gt; &quot;%{count} characters is the maximum allowed&quot;
end
</pre>
</div>
</notextile>

<p>This helper counts characters by default, but you can split the value in a different way using the <tt>:tokenizer</tt> option:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Essay &lt; ActiveRecord::Base
  validates_length_of :content,
    :minimum   =&gt; 300,
    :maximum   =&gt; 400,
    :tokenizer =&gt; lambda { |str| str.scan(/\w+/) },
    :too_short =&gt; &quot;must have at least %{count} words&quot;,
    :too_long  =&gt; &quot;must have at most %{count} words&quot;
end
</pre>
</div>
</notextile>

<p>The <tt>validates_size_of</tt> helper is an alias for <tt>validates_length_of</tt>.</p>
<h4 id="validates_numericality_of">3.8 <tt>validates_numericality_of</tt></h4>
<p>This helper validates that your attributes have only numeric values. By default, it will match an optional sign followed by an integral or floating point number. To specify that only integral numbers are allowed set <tt>:only_integer</tt> to true.</p>
<p>If you set <tt>:only_integer</tt> to <tt>true</tt>, then it will use the</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
/\A[+-]?\d+\Z/
</pre>
</div>
</notextile>

<p>regular expression to validate the attribute&#8217;s value. Otherwise, it will try to convert the value to a number using <tt>Float</tt>.</p>
<div class='warning'><p>Note that the regular expression above allows a trailing newline character.</p></div>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Player &lt; ActiveRecord::Base
  validates_numericality_of :points
  validates_numericality_of :games_played, :only_integer =&gt; true
end
</pre>
</div>
</notextile>

<p>Besides <tt>:only_integer</tt>, the <tt>validates_numericality_of</tt> helper also accepts the following options to add constraints to acceptable values:</p>
<ul>
	<li><tt>:greater_than</tt> &#8211; Specifies the value must be greater than the supplied value. The default error message for this option is &#8220;<em>must be greater than %{count}</em>&#8221;.</li>
	<li><tt>:greater_than_or_equal_to</tt> &#8211; Specifies the value must be greater than or equal to the supplied value. The default error message for this option is &#8220;<em>must be greater than or equal to %{count}</em>&#8221;.</li>
	<li><tt>:equal_to</tt> &#8211; Specifies the value must be equal to the supplied value. The default error message for this option is &#8220;<em>must be equal to %{count}</em>&#8221;.</li>
	<li><tt>:less_than</tt> &#8211; Specifies the value must be less than the supplied value. The default error message for this option is &#8220;<em>must be less than %{count}</em>&#8221;.</li>
	<li><tt>:less_than_or_equal_to</tt> &#8211; Specifies the value must be less than or equal the supplied value. The default error message for this option is &#8220;<em>must be less than or equal to %{count}</em>&#8221;.</li>
	<li><tt>:odd</tt> &#8211; Specifies the value must be an odd number if set to true. The default error message for this option is &#8220;<em>must be odd</em>&#8221;.</li>
	<li><tt>:even</tt> &#8211; Specifies the value must be an even number if set to true. The default error message for this option is &#8220;<em>must be even</em>&#8221;.</li>
</ul>
<p>The default error message for <tt>validates_numericality_of</tt> is &#8220;<em>is not a number</em>&#8221;.</p>
<h4 id="validates_presence_of">3.9 <tt>validates_presence_of</tt></h4>
<p>This helper validates that the specified attributes are not empty. It uses the <tt>blank?</tt> method to check if the value is either <tt>nil</tt> or a blank string, that is, a string that is either empty or consists of whitespace.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates :name, :login, :email, :presence =&gt; true
end
</pre>
</div>
</notextile>

<p>If you want to be sure that an association is present, you&#8217;ll need to test whether the foreign key used to map the association is present, and not the associated object itself.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class LineItem &lt; ActiveRecord::Base
  belongs_to :order
  validates_presence_of :order_id
end
</pre>
</div>
</notextile>

<p>Since <tt>false.blank?</tt> is true, if you want to validate the presence of a boolean field you should use <tt>validates_inclusion_of :field_name, :in => [true, false]</tt>.</p>
<p>The default error message for <tt>validates_presence_of</tt> is &#8220;<em>can&#8217;t be empty</em>&#8221;.</p>
<h4 id="validates_uniqueness_of">3.10 <tt>validates_uniqueness_of</tt></h4>
<p>This helper validates that the attribute&#8217;s value is unique right before the object gets saved. It does not create a uniqueness constraint in the database, so it may happen that two different database connections create two records with the same value for a column that you intend to be unique. To avoid that, you must create a unique index in your database.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Account &lt; ActiveRecord::Base
  validates_uniqueness_of :email
end
</pre>
</div>
</notextile>

<p>The validation happens by performing an <span class="caps">SQL</span> query into the model&#8217;s table, searching for an existing record with the same value in that attribute.</p>
<p>There is a <tt>:scope</tt> option that you can use to specify other attributes that are used to limit the uniqueness check:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Holiday &lt; ActiveRecord::Base
  validates_uniqueness_of :name, :scope =&gt; :year,
    :message =&gt; &quot;should happen once per year&quot;
end
</pre>
</div>
</notextile>

<p>There is also a <tt>:case_sensitive</tt> option that you can use to define whether the uniqueness constraint will be case sensitive or not. This option defaults to true.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_uniqueness_of :name, :case_sensitive =&gt; false
end
</pre>
</div>
</notextile>

<div class='warning'><p>Note that some databases are configured to perform case-insensitive searches anyway.</p></div>
<p>The default error message for <tt>validates_uniqueness_of</tt> is &#8220;<em>has already been taken</em>&#8221;.</p>
<h4 id="validates_with">3.11 <tt>validates_with</tt></h4>
<p>This helper passes the record to a separate class for validation.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_with GoodnessValidator
end

class GoodnessValidator &lt; ActiveModel::Validator
  def validate
    if record.first_name == &quot;Evil&quot;
      record.errors[:base] &lt;&lt; &quot;This person is evil&quot;
    end
  end
end
</pre>
</div>
</notextile>

<p>The <tt>validates_with</tt> helper takes a class, or a list of classes to use for validation. There is no default error message for <tt>validates_with</tt>. You must manually add errors to the record&#8217;s errors collection in the validator class.</p>
<p>The validator class has two attributes by default:</p>
<ul>
	<li><tt>record</tt> &#8211; the record to be validated</li>
	<li><tt>options</tt> &#8211; the extra options that were passed to <tt>validates_with</tt></li>
</ul>
<p>Like all other validations, <tt>validates_with</tt> takes the <tt>:if</tt>, <tt>:unless</tt> and <tt>:on</tt> options. If you pass any other options, it will send those options to the validator class as <tt>options</tt>:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_with GoodnessValidator, :fields =&gt; [:first_name, :last_name]
end

class GoodnessValidator &lt; ActiveRecord::Validator
  def validate
    if options[:fields].any?{|field| record.send(field) == &quot;Evil&quot; }
      record.errors[:base] &lt;&lt; &quot;This person is evil&quot;
    end
  end
end
</pre>
</div>
</notextile>

<h4 id="validates_each">3.12 <tt>validates_each</tt></h4>
<p>This helper validates attributes against a block. It doesn&#8217;t have a predefined validation function. You should create one using a block, and every attribute passed to <tt>validates_each</tt> will be tested against it. In the following example, we don&#8217;t want names and surnames to begin with lower case.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_each :name, :surname do |model, attr, value|
    model.errors.add(attr, 'must start with upper case') if value =~ /\A[a-z]/
  end
end
</pre>
</div>
</notextile>

<p>The block receives the model, the attribute&#8217;s name and the attribute&#8217;s value. You can do anything you like to check for valid data within the block. If your validation fails, you can add an error message to the model, therefore making it invalid.</p>
<h3 id="common-validation-options">4 Common Validation Options</h3>
<p>There are some common options that all the validation helpers can use. Here they are, except for the <tt>:if</tt> and <tt>:unless</tt> options, which are discussed later in <a href="#conditional-validation">Conditional Validation</a>.</p>
<h4 id="allow_nil">4.1 <tt>:allow_nil</tt></h4>
<p>The <tt>:allow_nil</tt> option skips the validation when the value being validated is <tt>nil</tt>. Using <tt>:allow_nil</tt> with <tt>validates_presence_of</tt> allows for <tt>nil</tt>, but any other <tt>blank?</tt> value will still be rejected.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Coffee &lt; ActiveRecord::Base
  validates_inclusion_of :size, :in =&gt; %w(small medium large),
    :message =&gt; &quot;%{value} is not a valid size&quot;, :allow_nil =&gt; true
end
</pre>
</div>
</notextile>

<h4 id="allow_blank">4.2 <tt>:allow_blank</tt></h4>
<p>The <tt>:allow_blank</tt> option is similar to the <tt>:allow_nil</tt> option. This option will let validation pass if the attribute&#8217;s value is <tt>blank?</tt>, like <tt>nil</tt> or an empty string for example.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Topic &lt; ActiveRecord::Base
  validates_length_of :title, :is =&gt; 5, :allow_blank =&gt; true
end

Topic.create(&quot;title&quot; =&gt; &quot;&quot;).valid? # =&gt; true
Topic.create(&quot;title&quot; =&gt; nil).valid? # =&gt; true
</pre>
</div>
</notextile>

<h4 id="message">4.3 <tt>:message</tt></h4>
<p>As you&#8217;ve already seen, the <tt>:message</tt> option lets you specify the message that will be added to the <tt>errors</tt> collection when validation fails. When this option is not used, Active Record will use the respective default error message for each validation helper.</p>
<h4 id="on">4.4 <tt>:on</tt></h4>
<p>The <tt>:on</tt> option lets you specify when the validation should happen. The default behavior for all the built-in validation helpers is to be run on save (both when you&#8217;re creating a new record and when you&#8217;re updating it). If you want to change it, you can use <tt>:on => :create</tt> to run the validation only when a new record is created or <tt>:on => :update</tt> to run the validation only when a record is updated.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  # it will be possible to update email with a duplicated value
  validates_uniqueness_of :email, :on =&gt; :create

  # it will be possible to create the record with a non-numerical age
  validates_numericality_of :age, :on =&gt; :update

  # the default (validates on both create and update)
  validates :name, :presence =&gt; true, :on =&gt; :save
end
</pre>
</div>
</notextile>

<h3 id="conditional-validation">5 Conditional Validation</h3>
<p>Sometimes it will make sense to validate an object just when a given predicate is satisfied. You can do that by using the <tt>:if</tt> and <tt>:unless</tt> options, which can take a symbol, a string or a <tt>Proc</tt>. You may use the <tt>:if</tt> option when you want to specify when the validation <strong>should</strong> happen. If you want to specify when the validation <strong>should not</strong> happen, then you may use the <tt>:unless</tt> option.</p>
<h4 id="using-a-symbol-with-if-and-unless">5.1 Using a Symbol with <tt>:if</tt> and <tt>:unless</tt></h4>
<p>You can associate the <tt>:if</tt> and <tt>:unless</tt> options with a symbol corresponding to the name of a method that will get called right before validation happens. This is the most commonly used option.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Order &lt; ActiveRecord::Base
  validates_presence_of :card_number, :if =&gt; :paid_with_card?

  def paid_with_card?
    payment_type == &quot;card&quot;
  end
end
</pre>
</div>
</notextile>

<h4 id="using-a-string-with-if-and-unless">5.2 Using a String with <tt>:if</tt> and <tt>:unless</tt></h4>
<p>You can also use a string that will be evaluated using <tt>eval</tt> and needs to contain valid Ruby code. You should use this option only when the string represents a really short condition.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates_presence_of :surname, :if =&gt; &quot;name.nil?&quot;
end
</pre>
</div>
</notextile>

<h4 id="using-a-proc-with-if-and-unless">5.3 Using a Proc with <tt>:if</tt> and <tt>:unless</tt></h4>
<p>Finally, it&#8217;s possible to associate <tt>:if</tt> and <tt>:unless</tt> with a <tt>Proc</tt> object which will be called. Using a <tt>Proc</tt> object gives you the ability to write an inline condition instead of a separate method. This option is best suited for one-liners.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Account &lt; ActiveRecord::Base
  validates_confirmation_of :password,
    :unless =&gt; Proc.new { |a| a.password.blank? }
end
</pre>
</div>
</notextile>

<h3 id="creating-custom-validation-methods">6 Creating Custom Validation Methods</h3>
<p>When the built-in validation helpers are not enough for your needs, you can write your own validation methods.</p>
<p>Simply create methods that verify the state of your models and add messages to the <tt>errors</tt> collection when they are invalid. You must then register these methods by using one or more of the <tt>validate</tt>, <tt>validate_on_create</tt> or <tt>validate_on_update</tt> class methods, passing in the symbols for the validation methods&#8217; names.</p>
<p>You can pass more than one symbol for each class method and the respective validations will be run in the same order as they were registered.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Invoice &lt; ActiveRecord::Base
  validate :expiration_date_cannot_be_in_the_past,
    :discount_cannot_be_greater_than_total_value

  def expiration_date_cannot_be_in_the_past
    errors.add(:expiration_date, &quot;can't be in the past&quot;) if
      !expiration_date.blank? and expiration_date &lt; Date.today
  end

  def discount_cannot_be_greater_than_total_value
    errors.add(:discount, &quot;can't be greater than total value&quot;) if
      discount &gt; total_value
  end
end
</pre>
</div>
</notextile>

<p>You can even create your own validation helpers and reuse them in several different models. For example, an application that manages surveys may find it useful to express that a certain field corresponds to a set of choices:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActiveRecord::Base.class_eval do
  def self.validates_as_choice(attr_name, n, options={})
    validates_inclusion_of attr_name, {:in =&gt; 1..n}.merge(options)
  end
end
</pre>
</div>
</notextile>

<p>Simply reopen <tt>ActiveRecord::Base</tt> and define a class method like that. You&#8217;d typically put this code somewhere in <tt>config/initializers</tt>. You can use this helper like this:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Movie &lt; ActiveRecord::Base
  validates_as_choice :rating, 5
end
</pre>
</div>
</notextile>

<h3 id="working-with-validation-errors">7 데이터 검증 에러로 작업하기</h3>
<p>In addition to the <tt>valid?</tt> and <tt>invalid?</tt> methods covered earlier, Rails provides a number of methods for working with the <tt>errors</tt> collection and inquiring about the validity of objects.</p>
<p>The following is a list of the most commonly used methods. Please refer to the <tt>ActiveRecord::Errors</tt> documentation for a list of all the available methods.</p>
<h4 id="working_with_validation_errors-errors">7.1 <tt>errors</tt></h4>
<p>Returns an OrderedHash with all errors. Each key is the attribute name and the value is an array of strings with all errors.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates :name, :presence =&gt; true
  validates_length_of :name, :minimum =&gt; 3
end

person = Person.new
person.valid? # =&gt; false
person.errors
 # =&gt; {:name =&gt; [&quot;can't be blank&quot;, &quot;is too short (minimum is 3 characters)&quot;]}

person = Person.new(:name =&gt; &quot;John Doe&quot;)
person.valid? # =&gt; true
person.errors # =&gt; []
</pre>
</div>
</notextile>

<h4 id="working_with_validation_errors-errors-2">7.2 <tt>errors[]</tt></h4>
<p><tt>errors[]</tt> is used when you want to check the error messages for a specific attribute. It returns an array of strings with all error messages for the given attribute, each string with one error message. If there are no errors related to the attribute, it returns an empty array.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates :name, :presence =&gt; true
  validates_length_of :name, :minimum =&gt; 3
end

person = Person.new(:name =&gt; &quot;John Doe&quot;)
person.valid? # =&gt; true
person.errors[:name] # =&gt; []

person = Person.new(:name =&gt; &quot;JD&quot;)
person.valid? # =&gt; false
person.errors[:name] # =&gt; [&quot;is too short (minimum is 3 characters)&quot;]

person = Person.new
person.valid? # =&gt; false
person.errors[:name]
 # =&gt; [&quot;can't be blank&quot;, &quot;is too short (minimum is 3 characters)&quot;]
</pre>
</div>
</notextile>

<h4 id="errors-add">7.3 <tt>errors.add</tt></h4>
<p>The <tt>add</tt> method lets you manually add messages that are related to particular attributes. You can use the <tt>errors.full_messages</tt> or <tt>errors.to_a</tt> methods to view the messages in the form they might be displayed to a user. Those particular messages get the attribute name prepended (and capitalized). <tt>add</tt> receives the name of the attribute you want to add the message to, and the message itself.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  def a_method_used_for_validation_purposes
    errors.add(:name, &quot;cannot contain the characters !@#%*()_-+=&quot;)
  end
end

person = Person.create(:name =&gt; &quot;!@#&quot;)

person.errors[:name]
 # =&gt; [&quot;cannot contain the characters !@#%*()_-+=&quot;]

person.errors.full_messages
 # =&gt; [&quot;Name cannot contain the characters !@#%*()_-+=&quot;]
</pre>
</div>
</notextile>

<p>Another way to do this is using <tt>[]=</tt> setter</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
    def a_method_used_for_validation_purposes
      errors[:name] = &quot;cannot contain the characters !@#%*()_-+=&quot;
    end
  end

  person = Person.create(:name =&gt; &quot;!@#&quot;)

  person.errors[:name]
   # =&gt; [&quot;cannot contain the characters !@#%*()_-+=&quot;]

  person.errors.to_a
   # =&gt; [&quot;Name cannot contain the characters !@#%*()_-+=&quot;]
</pre>
</div>
</notextile>

<h4 id="errors-base">7.4 <tt>errors[:base]</tt></h4>
<p>You can add error messages that are related to the object&#8217;s state as a whole, instead of being related to a specific attribute. You can use this method when you want to say that the object is invalid, no matter the values of its attributes. Since <tt>errors[:base]</tt> is an array, you can simply add a string to the array and uses it as the error message.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  def a_method_used_for_validation_purposes
    errors[:base] &lt;&lt; &quot;This person is invalid because ...&quot;
  end
end
</pre>
</div>
</notextile>

<h4 id="errors-clear">7.5 <tt>errors.clear</tt></h4>
<p>The <tt>clear</tt> method is used when you intentionally want to clear all the messages in the <tt>errors</tt> collection. Of course, calling <tt>errors.clear</tt> upon an invalid object won&#8217;t actually make it valid: the <tt>errors</tt> collection will now be empty, but the next time you call <tt>valid?</tt> or any method that tries to save this object to the database, the validations will run again. If any of the validations fail, the <tt>errors</tt> collection will be filled again.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates :name, :presence =&gt; true
  validates_length_of :name, :minimum =&gt; 3
end

person = Person.new
person.valid? # =&gt; false
person.errors[:name]
 # =&gt; [&quot;can't be blank&quot;, &quot;is too short (minimum is 3 characters)&quot;]

person.errors.clear
person.errors.empty? # =&gt; true

p.save # =&gt; false

p.errors[:name]
 # =&gt; [&quot;can't be blank&quot;, &quot;is too short (minimum is 3 characters)&quot;]
</pre>
</div>
</notextile>

<h4 id="errors-size">7.6 <tt>errors.size</tt></h4>
<p>The <tt>size</tt> method returns the total number of error messages for the object.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Person &lt; ActiveRecord::Base
  validates :name, :presence =&gt; true
  validates_length_of   :name, :minimum =&gt; 3
  validates_presence_of :email
end

person = Person.new
person.valid? # =&gt; false
person.errors.size # =&gt; 3

person = Person.new(:name =&gt; &quot;Andrea&quot;, :email =&gt; &quot;andrea@example.com&quot;)
person.valid? # =&gt; true
person.errors.size # =&gt; 0
</pre>
</div>
</notextile>

<h3 id="displaying-validation-errors-in-the-view">8 Displaying Validation Errors in the View</h3>
<p>Rails provides built-in helpers to display the error messages of your models in your view templates.</p>
<h4 id="error_messages-and-error_messages_for">8.1 <tt>error_messages</tt> and <tt>error_messages_for</tt></h4>
<p>When creating a form with the <tt>form_for</tt> helper, you can use the <tt>error_messages</tt> method on the form builder to render all failed validation messages for the current model instance.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Product &lt; ActiveRecord::Base
  validates_presence_of :description, :value
  validates_numericality_of :value, :allow_nil =&gt; true
end
</pre>
</div>
</notextile>

<notextile>
<div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= form_for(@product) do |f| %&gt;
  &lt;%= f.error_messages %&gt;
  &lt;p&gt;
    &lt;%= f.label :description %&gt;&lt;br /&gt;
    &lt;%= f.text_field :description %&gt;
  &lt;/p&gt;
  &lt;p&gt;
    &lt;%= f.label :value %&gt;&lt;br /&gt;
    &lt;%= f.text_field :value %&gt;
  &lt;/p&gt;
  &lt;p&gt;
    &lt;%= f.submit &quot;Create&quot; %&gt;
  &lt;/p&gt;
&lt;% end %&gt;
</pre>
</div>
</notextile>

<p>To get the idea, if you submit the form with empty fields you typically get this back, though styles are indeed missing by default:</p>
<p><img src="images/error_messages.png" title="Error messages" alt="Error messages" /></p>
<p>You can also use the <tt>error_messages_for</tt> helper to display the error messages of a model assigned to a view template. It&#8217;s very similar to the previous example and will achieve exactly the same result.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= error_messages_for :product %&gt;
</pre>
</div>
</notextile>

<p>The displayed text for each error message will always be formed by the capitalized name of the attribute that holds the error, followed by the error message itself.</p>
<p>Both the <tt>form.error_messages</tt> and the <tt>error_messages_for</tt> helpers accept options that let you customize the <tt>div</tt> element that holds the messages, changing the header text, the message below the header text and the tag used for the element that defines the header.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= f.error_messages :header_message =&gt; &quot;Invalid product!&quot;,
  :message =&gt; &quot;You'll need to fix the following fields:&quot;,
  :header_tag =&gt; :h3 %&gt;
</pre>
</div>
</notextile>

<p>Which results in the following content:</p>
<p><img src="images/customized_error_messages.png" title="Customized error messages" alt="Customized error messages" /></p>
<p>If you pass <tt>nil</tt> to any of these options, it will get rid of the respective section of the <tt>div</tt>.</p>
<h4 id="customizing-the-error-messages-css">8.2 Customizing the Error Messages <span class="caps">CSS</span></h4>
<p>The selectors to customize the style of error messages are:</p>
<ul>
	<li><tt>.field_with_errors</tt> &#8211; Style for the form fields and labels with errors.</li>
	<li><tt>#errorExplanation</tt> &#8211; Style for the <tt>div</tt> element with the error messages.</li>
	<li><tt>#errorExplanation h2</tt> &#8211; Style for the header of the <tt>div</tt> element.</li>
	<li><tt>#errorExplanation p</tt> &#8211; Style for the paragraph that holds the message that appears right below the header of the <tt>div</tt> element.</li>
	<li><tt>#errorExplanation ul li</tt> &#8211; Style for the list items with individual error messages.</li>
</ul>
<p>Scaffolding for example generates <tt>public/stylesheets/scaffold.css</tt>, which defines the red-based style you saw above.</p>
<p>The name of the class and the id can be changed with the <tt>:class</tt> and <tt>:id</tt> options, accepted by both helpers.</p>
<h4 id="customizing-the-error-messages-html">8.3 Customizing the Error Messages <span class="caps">HTML</span></h4>
<p>By default, form fields with errors are displayed enclosed by a <tt>div</tt> element with the <tt>field_with_errors</tt> <span class="caps">CSS</span> class. However, it&#8217;s possible to override that.</p>
<p>The way form fields with errors are treated is defined by <tt>ActionView::Base.field_error_proc</tt>. This is a <tt>Proc</tt> that receives two parameters:</p>
<ul>
	<li>A string with the <span class="caps">HTML</span> tag</li>
	<li>An instance of <tt>ActionView::Helpers::InstanceTag</tt>.</li>
</ul>
<p>Here is a simple example where we change the Rails behaviour to always display the error messages in front of each of the form fields with errors. The error messages will be enclosed by a <tt>span</tt> element with a <tt>validation-error</tt> <span class="caps">CSS</span> class. There will be no <tt>div</tt> element enclosing the <tt>input</tt> element, so we get rid of that red border around the text field. You can use the <tt>validation-error</tt> <span class="caps">CSS</span> class to style it anyway you want.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActionView::Base.field_error_proc = Proc.new do |html_tag, instance|
  if instance.error_message.kind_of?(Array)
    %(#{html_tag}&lt;span class=&quot;validation-error&quot;&gt;&amp;nbsp;
      #{instance.error_message.join(',')}&lt;/span&gt;).html_safe
  else
    %(#{html_tag}&lt;span class=&quot;validation-error&quot;&gt;&amp;nbsp;
      #{instance.error_message}&lt;/span&gt;).html_safe
  end
end
</pre>
</div>
</notextile>

<p>This will result in something like the following:</p>
<p><img src="images/validation_error_messages.png" title="Validation error messages" alt="Validation error messages" /></p>
<h3 id="callbacks-overview">9 Callbacks Overview</h3>
<p>Callbacks are methods that get called at certain moments of an object&#8217;s life cycle. With callbacks it&#8217;s possible to write code that will run whenever an Active Record object is created, saved, updated, deleted, validated, or loaded from the database.</p>
<h4 id="callback-registration">9.1 Callback Registration</h4>
<p>In order to use the available callbacks, you need to register them. You can do that by implementing them as ordinary methods, and then using a macro-style class method to register them as callbacks.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  validates_presence_of :login, :email

  before_validation :ensure_login_has_a_value

  protected
  def ensure_login_has_a_value
    if login.nil?
      self.login = email unless email.blank?
    end
  end
end
</pre>
</div>
</notextile>

<p>The macro-style class methods can also receive a block. Consider using this style if the code inside your block is so short that it fits in just one line.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  validates_presence_of :login, :email

  before_create {|user| user.name = user.login.capitalize
	if user.name.blank?}
end
</pre>
</div>
</notextile>

<p>It&#8217;s considered good practice to declare callback methods as being protected or private. If left public, they can be called from outside of the model and violate the principle of object encapsulation.</p>
<h3 id="available-callbacks">10 Available Callbacks</h3>
<p>Here is a list with all the available Active Record callbacks, listed in the same order in which they will get called during the respective operations:</p>
<h4 id="creating-an-object">10.1 Creating an Object</h4>
<ul>
	<li><tt>before_validation</tt></li>
	<li><tt>after_validation</tt></li>
	<li><tt>before_save</tt></li>
	<li><tt>after_save</tt></li>
	<li><tt>before_create</tt></li>
	<li><tt>around_create</tt></li>
	<li><tt>after_create</tt></li>
</ul>
<h4 id="updating-an-object">10.2 Updating an Object</h4>
<ul>
	<li><tt>before_validation</tt></li>
	<li><tt>after_validation</tt></li>
	<li><tt>before_save</tt></li>
	<li><tt>after_save</tt></li>
	<li><tt>before_update</tt></li>
	<li><tt>around_update</tt></li>
	<li><tt>after_update</tt></li>
</ul>
<h4 id="destroying-an-object">10.3 Destroying an Object</h4>
<ul>
	<li><tt>before_destroy</tt></li>
	<li><tt>after_destroy</tt></li>
	<li><tt>around_destroy</tt></li>
</ul>
<div class='warning'><p><tt>after_save</tt> runs both on create and update, but always <em>after</em> the more specific callbacks <tt>after_create</tt> and <tt>after_update</tt>, no matter the order in which the macro calls were executed.</p></div>
<h4 id="after_initialize-and-after_find">10.4 <tt>after_initialize</tt> and <tt>after_find</tt></h4>
<p>The <tt>after_initialize</tt> callback will be called whenever an Active Record object is instantiated, either by directly using <tt>new</tt> or when a record is loaded from the database. It can be useful to avoid the need to directly override your Active Record <tt>initialize</tt> method.</p>
<p>The <tt>after_find</tt> callback will be called whenever Active Record loads a record from the database. <tt>after_find</tt> is called before <tt>after_initialize</tt> if both are defined.</p>
<p>The <tt>after_initialize</tt> and <tt>after_find</tt> callbacks are a bit different from the others. They have no <tt>before_*</tt> counterparts, and the only way to register them is by defining them as regular methods. If you try to register <tt>after_initialize</tt> or <tt>after_find</tt> using macro-style class methods, they will just be ignored. This behaviour is due to performance reasons, since <tt>after_initialize</tt> and <tt>after_find</tt> will both be called for each record found in the database, significantly slowing down the queries.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  def after_initialize
    puts &quot;You have initialized an object!&quot;
  end

  def after_find
    puts &quot;You have found an object!&quot;
  end
end

&gt;&gt; User.new
You have initialized an object!
=&gt; #&lt;User id: nil&gt;

&gt;&gt; User.first
You have found an object!
You have initialized an object!
=&gt; #&lt;User id: 1&gt;
</pre>
</div>
</notextile>

<h3 id="running-callbacks">11 Running Callbacks</h3>
<p>The following methods trigger callbacks:</p>
<ul>
	<li><tt>create</tt></li>
	<li><tt>create!</tt></li>
	<li><tt>decrement!</tt></li>
	<li><tt>destroy</tt></li>
	<li><tt>destroy_all</tt></li>
	<li><tt>increment!</tt></li>
	<li><tt>save</tt></li>
	<li><tt>save!</tt></li>
	<li><tt>save(false)</tt></li>
	<li><tt>toggle!</tt></li>
	<li><tt>update</tt></li>
	<li><tt>update_attribute</tt></li>
	<li><tt>update_attributes</tt></li>
	<li><tt>update_attributes!</tt></li>
	<li><tt>valid?</tt></li>
</ul>
<p>Additionally, the <tt>after_find</tt> callback is triggered by the following finder methods:</p>
<ul>
	<li><tt>all</tt></li>
	<li><tt>first</tt></li>
	<li><tt>find</tt></li>
	<li><tt>find_all_by_<em>attribute</em></tt></li>
	<li><tt>find_by_<em>attribute</em></tt></li>
	<li><tt>find_by_<em>attribute</em>!</tt></li>
	<li><tt>last</tt></li>
</ul>
<p>The <tt>after_initialize</tt> callback is triggered every time a new object of the class is initialized.</p>
<h3 id="skipping-callbacks">12 Skipping Callbacks</h3>
<p>Just as with validations, it&#8217;s also possible to skip callbacks. These methods should be used with caution, however, because important business rules and application logic may be kept in callbacks. Bypassing them without understanding the potential implications may lead to invalid data.</p>
<ul>
	<li><tt>decrement</tt></li>
	<li><tt>decrement_counter</tt></li>
	<li><tt>delete</tt></li>
	<li><tt>delete_all</tt></li>
	<li><tt>find_by_sql</tt></li>
	<li><tt>increment</tt></li>
	<li><tt>increment_counter</tt></li>
	<li><tt>toggle</tt></li>
	<li><tt>update_all</tt></li>
	<li><tt>update_counters</tt></li>
</ul>
<h3 id="halting-execution">13 Halting Execution</h3>
<p>As you start registering new callbacks for your models, they will be queued for execution. This queue will include all your model&#8217;s validations, the registered callbacks, and the database operation to be executed.</p>
<p>The whole callback chain is wrapped in a transaction. If any <em>before</em> callback method returns exactly <tt>false</tt> or raises an exception the execution chain gets halted and a <span class="caps">ROLLBACK</span> is issued; <em>after</em> callbacks can only accomplish that by raising an exception.</p>
<div class='warning'><p>Raising an arbitrary exception may break code that expects <tt>save</tt> and friends not to fail like that. The <tt>ActiveRecord::Rollback</tt> exception is thought precisely to tell Active Record a rollback is going on. That one is internally captured but not reraised.</p></div>
<h3 id="relational-callbacks">14 Relational Callbacks</h3>
<p>Callbacks work through model relationships, and can even be defined by them. Let&#8217;s take an example where a user has many posts. In our example, a user&#8217;s posts should be destroyed if the user is destroyed. So, we&#8217;ll add an <tt>after_destroy</tt> callback to the <tt>User</tt> model by way of its relationship to the <tt>Post</tt> model.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  has_many :posts, :dependent =&gt; :destroy
end

class Post &lt; ActiveRecord::Base
  after_destroy :log_destroy_action

  def log_destroy_action
    puts 'Post destroyed'
  end
end

&gt;&gt; user = User.first
=&gt; #&lt;User id: 1&gt;
&gt;&gt; user.posts.create!
=&gt; #&lt;Post id: 1, user_id: 1&gt;
&gt;&gt; user.destroy
Post destroyed
=&gt; #&lt;User id: 1&gt;
</pre>
</div>
</notextile>

<h3 id="conditional-callbacks">15 Conditional Callbacks</h3>
<p>Like in validations, we can also make our callbacks conditional, calling them only when a given predicate is satisfied. You can do that by using the <tt>:if</tt> and <tt>:unless</tt> options, which can take a symbol, a string or a <tt>Proc</tt>. You may use the <tt>:if</tt> option when you want to specify when the callback <strong>should</strong> get called. If you want to specify when the callback <strong>should not</strong> be called, then you may use the <tt>:unless</tt> option.</p>
<h4 id="using-if-and-unless-with-a-symbol">15.1 Using <tt>:if</tt> and <tt>:unless</tt> with a Symbol</h4>
<p>You can associate the <tt>:if</tt> and <tt>:unless</tt> options with a symbol corresponding to the name of a method that will get called right before the callback. When using the <tt>:if</tt> option, the callback won&#8217;t be executed if the method returns false; when using the <tt>:unless</tt> option, the callback won&#8217;t be executed if the method returns true. This is the most common option. Using this form of registration it&#8217;s also possible to register several different methods that should be called to check if the callback should be executed.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Order &lt; ActiveRecord::Base
  before_save :normalize_card_number, :if =&gt; :paid_with_card?
end
</pre>
</div>
</notextile>

<h4 id="using-if-and-unless-with-a-string">15.2 Using <tt>:if</tt> and <tt>:unless</tt> with a String</h4>
<p>You can also use a string that will be evaluated using <tt>eval</tt> and needs to contain valid Ruby code. You should use this option only when the string represents a really short condition.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Order &lt; ActiveRecord::Base
  before_save :normalize_card_number, :if =&gt; &quot;paid_with_card?&quot;
end
</pre>
</div>
</notextile>

<h4 id="using-if-and-unless-with-a-proc">15.3 Using <tt>:if</tt> and <tt>:unless</tt> with a Proc</h4>
<p>Finally, it&#8217;s possible to associate <tt>:if</tt> and <tt>:unless</tt> with a <tt>Proc</tt> object. This option is best suited when writing short validation methods, usually one-liners.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Order &lt; ActiveRecord::Base
  before_save :normalize_card_number,
    :if =&gt; Proc.new { |order| order.paid_with_card? }
end
</pre>
</div>
</notextile>

<h4 id="multiple-conditions-for-callbacks">15.4 Multiple Conditions for Callbacks</h4>
<p>When writing conditional callbacks, it&#8217;s possible to mix both <tt>:if</tt> and <tt>:unless</tt> in the same callback declaration.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Comment &lt; ActiveRecord::Base
  after_create :send_email_to_author, :if =&gt; :author_wants_emails?,
    :unless =&gt; Proc.new { |comment| comment.post.ignore_comments? }
end
</pre>
</div>
</notextile>

<h3 id="callback-classes">16 Callback Classes</h3>
<p>Sometimes the callback methods that you&#8217;ll write will be useful enough to be reused by other models. Active Record makes it possible to create classes that encapsulate the callback methods, so it becomes very easy to reuse them.</p>
<p>Here&#8217;s an example where we create a class with an <tt>after_destroy</tt> callback for a <tt>PictureFile</tt> model.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class PictureFileCallbacks
  def after_destroy(picture_file)
    File.delete(picture_file.filepath)
      if File.exists?(picture_file.filepath)
  end
end
</pre>
</div>
</notextile>

<p>When declared inside a class the callback method will receive the model object as a parameter. We can now use it this way:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class PictureFile &lt; ActiveRecord::Base
  after_destroy PictureFileCallbacks.new
end
</pre>
</div>
</notextile>

<p>Note that we needed to instantiate a new <tt>PictureFileCallbacks</tt> object, since we declared our callback as an instance method. Sometimes it will make more sense to have it as a class method.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class PictureFileCallbacks
  def self.after_destroy(picture_file)
    File.delete(picture_file.filepath)
      if File.exists?(picture_file.filepath)
  end
end
</pre>
</div>
</notextile>

<p>If the callback method is declared this way, it won&#8217;t be necessary to instantiate a <tt>PictureFileCallbacks</tt> object.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class PictureFile &lt; ActiveRecord::Base
  after_destroy PictureFileCallbacks
end
</pre>
</div>
</notextile>

<p>You can declare as many callbacks as you want inside your callback classes.</p>
<h3 id="observers">17 Observers</h3>
<p>Observers are similar to callbacks, but with important differences. Whereas callbacks can pollute a model with code that isn&#8217;t directly related to its purpose, observers allow you to add the same functionality outside of a model. For example, it could be argued that a <tt>User</tt> model should not include code to send registration confirmation emails. Whenever you use callbacks with code that isn&#8217;t directly related to your model, you may want to consider creating an observer instead.</p>
<h4 id="creating-observers">17.1 Creating Observers</h4>
<p>For example, imagine a <tt>User</tt> model where we want to send an email every time a new user is created. Because sending emails is not directly related to our model&#8217;s purpose, we could create an observer to contain this functionality.</p>
<notextile>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
rails generate observer User
</pre>
</div>
</notextile>

<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class UserObserver &lt; ActiveRecord::Observer
  def after_create(model)
    # code to send confirmation email...
  end
end
</pre>
</div>
</notextile>

<p>As with callback classes, the observer&#8217;s methods receive the observed model as a parameter.</p>
<h4 id="registering-observers">17.2 Registering Observers</h4>
<p>Observers are conventionally placed inside of your <tt>app/models</tt> directory and registered in your application&#8217;s <tt>config/application.rb</tt> file. For example, the <tt>UserObserver</tt> above would be saved as <tt>app/models/user_observer.rb</tt> and registered in <tt>config/application.rb</tt> this way:</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Activate observers that should always be running
config.active_record.observers = :user_observer
</pre>
</div>
</notextile>

<p>As usual, settings in <tt>config/environments</tt> take precedence over those in <tt>config/application.rb</tt>. So, if you prefer that an observer doesn&#8217;t run in all environments, you can simply register it in a specific environment instead.</p>
<h4 id="sharing-observers">17.3 Sharing Observers</h4>
<p>By default, Rails will simply strip &#8220;Observer&#8221; from an observer&#8217;s name to find the model it should observe. However, observers can also be used to add behaviour to more than one model, and so it&#8217;s possible to manually specify the models that our observer should observe.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class MailerObserver &lt; ActiveRecord::Observer
  observe :registration, :user

  def after_create(model)
    # code to send confirmation email...
  end
end
</pre>
</div>
</notextile>

<p>In this example, the <tt>after_create</tt> method would be called whenever a <tt>Registration</tt> or <tt>User</tt> was created. Note that this new <tt>MailerObserver</tt> would also need to be registered in <tt>config/application.rb</tt> in order to take effect.</p>
<notextile>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Activate observers that should always be running
config.active_record.observers = :mailer_observer
</pre>
</div>
</notextile>

<h3 id="changelog">18 Changelog</h3>
<ul>
	<li>July 20, 2010: Fixed typos and rephrased some paragraphs for clarity. <a href="http://jaimeiniesta.com">Jaime Iniesta</a></li>
	<li>May 24, 2010: Fixed document to validate <span class="caps">XHTML</span> 1.0 Strict. <a href="http://jaimeiniesta.com">Jaime Iniesta</a></li>
	<li>May 15, 2010: Validation Errors section updated by <a href="http://www.eparreno.com">Emili Parreño</a></li>
	<li>March 7, 2009: Callbacks revision by Trevor Turk</li>
	<li>February 10, 2009: Observers revision by Trevor Turk</li>
	<li>February 5, 2009: Initial revision by Trevor Turk</li>
	<li>January 9, 2009: Initial version by <a href="credits.html#cmarques">Cássio Marques</a></li>
</ul>

        <h3>Feedback</h3>
        <p>
          You're encouraged to help in keeping the quality of this guide.
        </p>
        <p>
          If you see any typos or factual errors you are confident to
          patch, please clone <a href="https://github.com/lifo/docrails">docrails</a>
          and push the change yourself. That branch of Rails has public write access.
          Commits are still reviewed, but that happens after you've submitted your
          contribution. <a href="https://github.com/lifo/docrails">docrails</a> is
          cross-merged with master periodically.
        </p>
        <p>
          You may also find incomplete content, or stuff that is not up to date.
          Please do add any missing documentation for master. Check the
          <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a>
          for style and conventions.
        </p>
        <p>
          Issues may also be reported in <a href="https://github.com/lifo/docrails/issues">Github</a>.
        </p>
        <p>And last but not least, any kind of discussion regarding Ruby on Rails
          documentation is very welcome in the <a href="http://groups.google.com/group/rubyonrails-docs">rubyonrails-docs mailing list</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-Share Alike 3.0</a> License</p>
      <p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>
    </div>
  </div>

  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all()
  </script>
</body>
</html>
